\section{Computing size bounds}

In this chapter we will present the method, which is able to infer size bounds for the values of the variables at particular transitions of a program.


\subsection{Computing local size bounds}

\input{definitions/localsizebound}


\subsection{Computing trivial size bounds}

With the definition of local size bounds in the form of scaled sums, it is now possible to lift those local effects to a global level.
Instead of expressing the effect depending on the values immediately before a transition, we will now express the effect depending on the start values.

We first provide those global size bounds for trivial SCCs of the RVG.
Note that a node in the RVG is a result variable $\alpha = (t,v) \in \RV$.
Trivial SCCs consist of a single node and they have the property that every evaluation passes the SCC only once.
In the graph this is recognizable through the fact, that no sequence of edges is leading back to the single node.

Again, we have to distinguish two cases.
If the transition $t$ of the result variable $\alpha$ of the node is an initial transition $t \in \TSet_0$, then the effect of the local size bound already depends on the start values.
Thus, the local size bound for the result variable $\alpha$ is also a global size bound.
If the transition $t$ is not an initial transition $t \notin \TSet_0$, then we have to substitute the variables of the local size bound by the global size bounds before entering the SCC.
The old KoAT tool uses monotonically increasing bounds for the local size bounds.
Therefore it is able to substitute every variable with its upper size bound obtained so far.
Since the defined scaled sums for local size bounds of KoAT2 are non-monotonic, it is necessary to split additional cases.
For scaled sums we have monotonically increasing and monotonically decreasing components.
Let $\alpha = (t,v) \in \RV$ be a result variable.
Then, the upper local size bound $\ULSB(\alpha)$ and the lower local size bound $\LLSB(\alpha)$ are monotonically increasing for each variable $v \in P_{\alpha,1} \cup P_{\alpha,2}$.
On the other hand for each variable $v \in N_{\alpha,1} \cup N_{\alpha,2}$ the upper local size bound $\ULSB(\alpha)$ and the lower local size bound $\LLSB(\alpha)$ are monotonically decreasing.

The redefined upper size bound ${\USize}'$ must be a sound overapproximation of the values of the variables.
Since upper size bounds $\USize$ overapproximate the value of variables and lower size bounds $\LSize$ underapproximate the value, it is sound to use the upper size bound $\USize$ for the substitution with the monotonically increasing variables and the lower size bound $\LSize$ for the substitution with the monotonically decreasing variables.

The redefined lower size bound ${\LSize}'$ must be a sound underapproximation of the values of the variables.
Therefore the upper size bound $\USize$ must be used for the substitution with the monotonically decreasing variables and the lower size bound $\LSize$ must be used for the substitution with the monotonically increasing variables.
The following definition formally introduces the computation of size bounds for trivial SCCs.

\input{theorems/trivial_sizebound}

We explain the presented method with an example.
Consider the program in figure \ref{fig:trivial_sizebound_example}.

\input{graphs/trivial_sizebound_example}

The program takes an arbitrary $x$ and an $y \leq 0$ and returns $y$ unchanged while it assigns $x$ in both transitions a value depending on the incoming $x$ and $y$.
The result variable graph contains four trivial SCCs, each result variable forming an own SCC.
We now inspect the SCCs $\braced{(t_0,x)}$ and $\braced{(t_1,x)}$.

For the SCC $\braced{(t_0,x)}$ the transition $t_0$ is an initial transition.
We can determine a scaled sum $3 \cdot (1 + \maxO{x} - y)$ as upper local size bound $\ULSB(t_0,x)$ and a scaled sum $2 \cdot x$ as lower local size bound $\LLSB(t_0,x)$.
Since we have $\USize'(t_0,x) = \ULSB(t_0,x)$ and $\LSize'(t_0,x) = \LLSB(t_0,x)$, the determined local size bounds are also global size bounds.

For the SCC $\braced{(t_1,x)}$ the transition $t_1$ is not an initial transition.
Therefore the local size bound expresses the values of the variables in terms of their value immediately before the execution of $t_1$.
For the computation of the global size bounds we need to substitute these variables with the global size bound obtained so far until the execution of $t_1$.
We already inferred those size bounds $\USize(t_0,x)$ and $\LSize(t_0,x)$ for the single transition $t_0$ leading to $t_1$.
Additionally, we can trivially infer the size bounds $\USize(t_0,y) = y$ and $\LSize(t_0,y) = y$.
We can also determine a scaled sum $3 \cdot (\maxO{-x} + y)$ as upper local size bound $\ULSB(t_1,x)$ and a scaled sum $3 \cdot (-1 - \maxO{x} + y)$ as lower local size bound $\LLSB(t_1,x)$.
For the result variable $\alpha = (t_0,x)$ the parameters of the upper local size bound are $s^\sqcap_\alpha = 3$, $e^\sqcap_\alpha = 0$, $N^\sqcap_{\alpha,2} = \braced{x}$, $P^\sqcap_{\alpha,1} = \braced{y}$ and $P^\sqcap_{\alpha,2} = N^\sqcap_{\alpha,1} = \emptyset$ and the parameters of the lower local size bound are $s^\sqcup_\alpha = 3$, $e^\sqcup_\alpha = -1$, $N^\sqcup_{\alpha,2} = \braced{x}$, $P^\sqcup_{\alpha,1} = \braced{y}$ and $P^\sqcup_{\alpha,2} = N^\sqcup_{\alpha,1} = \emptyset$.
For a sound approximation it is necessary to substitute the variables with the correct incoming bounds depending on whether we want to infer an upper or lower bound and whether the sign of the variable is positive or negative.
The resulting global upper size bound $\USize'(t_0,x)$ therefore is 
\begin{align*}
  && 3 \cdot ( 0 + \USize(t_0, y) - 0 + 0 + \maxO{-\LSize(t_0, x)} ) \\
  & = & 3 \cdot ( y + \maxO{-2 \cdot x} )
\end{align*}
The resulting global lower size bound $\LSize'(t_0,x)$ we can determine as
\begin{align*}
  && 3 \cdot ( -1 + \LSize(t_0, y) - 0 + 0 + \maxO{-\USize(t_0, x)} ) \\
  & = & 3 \cdot ( -1 + y + \maxO{3 \cdot (1 + \maxO{x} - y)} )
\end{align*}


\subsection{Computing nontrivial size bounds}

In the last section we presented a method SizeBounds to infer upper and lower size bounds for result variables $\alpha \in \RV$ which form a trivial SCC $\braced{\alpha}$.
In this section we extend the method to infer upper and lower size bounds for nontrivial SCCs.
Prior to the definition of the method we define utility definitions.

\begin{definition}[Pre-variables]
  Let $\pre(\alpha) \subseteq \RV$ be an overapproximation of all the result variables that directly affect the value of a result variable $\alpha \in \RV$.
  Let $\pre^+(\alpha) \subseteq \pre(\alpha)$ be those possibly affecting result variables that enter for each possible evaluation with a positive value
  (i.e. for $\beta \in \pre^+(\alpha)$ it holds that $\LSize(\beta) > 0$).
  Similar, let $\pre^-(\alpha) \subseteq \pre(\alpha)$ be those possibly affecting result variables that enter for each possible evaluation with a negative value
  (i.e. for $\beta \in \pre^+(\alpha)$ it holds that $\USize(\beta) < 0$).
\end{definition}

\begin{definition}[SCC-variables]
  Let $\VSet_\alpha = \braced{ \tilde{v} \mid (\tilde{t}, \tilde{v}') \in \pre(\alpha) \cap \SCC }$ be an overapproximation of all variables occurring directly before $\alpha$ in $\SCC$ that may affect the value of $\alpha \in \RV$.
  Let $\VSet^+_\alpha = \braced{ \tilde{v} \mid (\tilde{t}, \tilde{v}') \in \pre^+(\alpha) \cap \SCC } \subseteq \VSet_\alpha$ be those variables from $\VSet_\alpha$ that enter for each possible evaluation with a positive value.
  Similar, let $\VSet^-_\alpha$ be the negative version.
\end{definition}

\input{theorems/nontrivial_sizebound}
