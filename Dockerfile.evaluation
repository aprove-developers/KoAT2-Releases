FROM ocaml/opam:alpine as koat2_build
LABEL author="Fabian Meyer"
LABEL author="Marcel Hark"

ARG OCAML_VERSION=4.11.2

RUN opam update
RUN opam upgrade
RUN opam switch create -y $OCAML_VERSION+musl+static+flambda
RUN eval `opam env`
RUN opam init
RUN opam update
RUN opam upgrade
# Add graphviz for tests
RUN sudo apk add m4 python2 gmp-dev perl mpfr-dev graphviz zip --no-cache

WORKDIR /home/opam

RUN wget -O "irankfinder.zip" https://github.com/jesusjda/pyRankFinder/releases/download/v1.3.1/irankfinder_v1.3.1_rhel7.zip && \
    mkdir irankfinder && \
    unzip irankfinder.zip -d irankfinder && \
    rm irankfinder.zip

COPY --chown=opam:opam opam .
RUN opam install -j $((`nproc` - 2)) . --deps-only

COPY --chown=opam:opam src ./src
COPY --chown=opam:opam OMakeroot .

COPY --chown=opam:opam OMakefile .
# needed to run tests
COPY --chown=opam:opam examples ./examples

ENV PATH=/home/opam/.opam/$OCAML_VERSION+musl+static+flambda/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/home/opam/src/main
ENV LD_LIBRARY_PATH=/home/opam/.opam/$OCAML_VERSION+musl+static+flambda/lib:/home/opam/.opam/$OCAML_VERSION+musl+static+flambda/lib/stublibs

# Run Build command
ARG KOAT2_VERSION_STRING=UNKNOWN
RUN RELEASE=1 KOAT2_GIT_VERSION=$KOAT2_VERSION_STRING omake --depend

FROM ubuntu:20.04

RUN apt-get update && \
    apt-get install -y graphviz libtinfo5 libgmp-dev

COPY scripts/koat2_assets/wrapper_script.sh bin/wrapper_script.sh
COPY scripts/koat2_assets/run_koat2_cfr_c.sh bin/run_koat2_cfr_c.sh
COPY scripts/koat2_assets/run_koat2_cfr.sh bin/run_koat2_cfr.sh
COPY scripts/koat2_assets/run_koat2_c.sh bin/run_koat2_c.sh
COPY scripts/koat2_assets/clang bin/clang
COPY scripts/koat2_assets/llvm2kittel bin/llvm2kittel

RUN mkdir /koat2
WORKDIR /koat2

COPY --from=koat2_build /home/opam/src/main/koat2.opt bin/koat2
COPY --from=koat2_build /home/opam/irankfinder ./irankfinder

RUN chmod +x /koat2/irankfinder/1.3.1/irankfinder/CFRefinement
#Update PATH to include the added executables
ENV PATH=$PATH:/koat2/bin:/koat2/irankfinder/1.3.1/irankfinder/partialevaluation/bin:/koat2/irankfinder/1.3.1/irankfinder/ppl:/koat2/irankfinder/1.3.1/irankfinder
ENV LD_LIBRARY_PATH=/home/koat2/irankfinder/1.3.1/irankfinder/ppl:/home/koat2/irankfinder/1.3.1/irankfinder/partialevaluation/bin:/home/koat2/irankfinder/1.3.1/irankfinder:/lib:/usr/local/lib:/usr/lib
ENTRYPOINT ["/bin/wrapper_script.sh"]
